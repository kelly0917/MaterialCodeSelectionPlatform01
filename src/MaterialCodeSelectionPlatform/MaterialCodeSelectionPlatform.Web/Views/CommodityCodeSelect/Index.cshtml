
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Body.cshtml";
}
<style>
    .selType {
        display: none;
    }
    /*.layui-form-label {
        width: 100px;
    }*/
    .checkboxContent {
        height: auto overflow: hidden;
    }

    /*.checkboxContent:hover {
            height: 20px;;
        }*/

    .layui-form-label {
        width: 140px;
    }

    .layui-form-item .layui-inline {
        /* margin-bottom: 5px; */
        /*margin-right: 10px;*/
    }

    .layui-form-item {
        margin-bottom: 0px;
    }

    .attributeContent {
        position: absolute;
        top: 110px;
        height: 10px;
        overflow: hidden;
        z-index: 10;
        width: 100%;
    }


    .layui-float-right {
        float: right;
        margin-left: 10px;
    }
</style>

<link href="~/js/jquery-ui.css" rel="stylesheet" />
<script src="~/js/jquery-ui.js"></script>

<link rel="stylesheet" type="text/css" href="~/lib/usteel-search/search.css?t=@DateTime.Now" />
<script type="text/javascript" src="~/lib/usteel-search/search.js?t=@DateTime.Now"></script>
<div class="layui-form" action="" id="searchForm">
    <div class="layui-form-item search">
        <div class="layui-inline layui-col-sm8.8">

            <label class="layui-form-label">物资类型：</label>
            <div class="layui-input-inline">
                <select lay-search id="selCatalog" name="selCatalog" lay-filter="selCatalog"></select>
            </div>

            <div class="layui-inline" id="divCPContainer">
                <div class="layui-input-inline" id="divsel200">
                    <select lay-search name="sel200" lay-filter="cpType"></select>
                </div>
            </div>
        </div>
        <div class="layui-inline" style="float: right">
            @*<div class="layui-inline layui-float-left">
                    <label class="layui-form-label">编码库：</label>
                    <div class="layui-input-inline">
                        <select lay-search id="selCatalog" name="selCatalog" lay-filter="selCatalog"></select>
                    </div>
                </div>*@
            <div class="layui-inline layui-float-left" style="display: none;">
                <label class="layui-form-label">项目：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selProject" name="selProject" lay-filter="selProject"></select>
                </div>
            </div>
            <div class="layui-inline layui-float-left" style="display: none;">
                <label class="layui-form-label">装置：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selDevice" name="selDevice" lay-filter="selDevice"></select>
                </div>
            </div>


            <button class="layui-btn layui-btn-normal layui-float-right" lay-filter="search" id="btnChangeProject" onclick="openProjectAgain()">项目</button>

            <div class="layui-inline layui-float-right">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="openReoprt()">查看</button>
            </div>
            @*<div id="divApprove" class="layui-inline layui-float-right">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="openApprove()">审批</button>
            </div>
            <div class="layui-inline layui-float-right">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="openMaterial()">裕量</button>
            </div>*@

            <div class="layui-inline layui-float-right">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnCopy" onclick="copy()">拷贝</button>
            </div>
            <div class="layui-inline layui-float-right">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="search()">搜索</button>

            </div>
        </div>
    </div>


    @*材料描述*@
    <div class="layui-form-item search">
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label">材料描述：</label>
            <div class="layui-input-inline">
                <input type="text" name="txtCode" class="layui-input" id="txtCode" lay-filter="txtCode" style="width: 622px" />
            </div>
        </div>
        <div class="layui-inline" style="float: right">
            <label class="layui-form-label" style="width: auto">当前项目：</label>
            <label class="layui-form-label" style="width: auto; padding-left: 0; padding-right: 0; color: green;" id="lbProject"></label>
            <label class="layui-form-label" style="width: auto">当前装置：</label>
            <label class="layui-form-label" style="width: auto;padding-left: 0; padding-right: 0;color: green;" id="lbDevice"></label>
        </div>
    </div>



    @*属性值列表*@
    <div class="layui-form-item search attributeContent" id="divAttrContainer">
    </div>

</div>


<div style="display: none" id="divReplaceSel">
    <div class="layui-input-inline" id="divsel{i}" index="{i}">
        <select lay-search name="sel{i}" lay-filter="cpType"></select>
    </div>
</div>

<input type="hidden" id="txtUserId" name="txtUserId" value="@ViewData["UserId"]" />
<input type="hidden" id="txtComponentTypeId" name="txtComponentTypeId" value="" />
<input type="hidden" id="txtMtoId" name="txtMtoId" value="" />
<div id="divTable">
    <table class="layui-table" lay-data="{height: 'full-200', cellMinWidth: 80}" id="tbCommodityCodeList" lay-filter="useruv"></table>
</div>
@*打开最近工作*@


<div class="layui-form" action="" id="openShow" style="display:none">
    <table class="layui-hide" id="mtoTable" lay-filter="mtoTool"></table>


    <div class="layui-layer-title" style="cursor: move;"> 新建工作...</div>
    <div class="layui-form " action="" id="searchForm2" >
        <div class="layui-form-item search">
            <div class="layui-inline layui-float-left">
                <label class="layui-form-label ">项目：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selProject2" name="selProject2" lay-filter="selProject2"></select>
                </div>
            </div>
            <div class="layui-inline  layui-float-left">
                <label class="layui-form-label">装置：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selDevice2" name="selDevice2" lay-filter="selDevice2"></select>
                </div>
            </div>
            <div class="layui-inline">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnOk" onclick="selectProjectDevice()">确定</button>
            </div>
        </div>
    </div>
</div>

@*审批页面*@
<div class="layui-form" action="" id="showApprove" style="display:none">
    <div class="layui-row">
        <div class="layui-col-xs12">
            <div class="layui-form-item">
                <label class="layui-form-label">版本号：</label>
                <div class="layui-input-inline" style="width:300px;padding:10px">
                    <input type="text" id="txtRevision" name="txtRevision" required lay-verify="required" placeholder="版本号" autocomplete="off" class="layui-input" maxlength="20">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">审批意见：</label>
                <div class="layui-input-inline" style="width:400px;padding:10px">
                    <textarea class="layui-textarea" id="txtApproveContent" name="txtApproveContent" style="margin-top: 0px; margin-bottom: 0px; height: 100px;"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">审批结果：</label>
                <div class="layui-input-inline" style="width:300px;padding:10px;top:-10px">
                    <input type="checkbox" id="txtcheckStatus" name="txtcheckStatus" lay-skin="primary" style="width:50px">  <label class="layui-form-label">审批通过</label>
                </div>
            </div>
        </div>
    </div>


    <div class="layui-form-item">
        <div class="layui-input-block layui-align-right" style="right:20px">
            <button class="layui-btn layui-bg-blue" lay-submit="" lay-filter="okApprove" onclick="okApprove()">确定</button>
            <button type="reset" class="layui-btn layui-bg-blue layui-btn-primary" onclick="closeApprove()">取消</button>
        </div>
    </div>
</div>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-sm permission" action="8" lay-event="attr">查看属性</a>
    <a class="layui-btn layui-btn-sm layui-btn-normal permission" action="2" lay-event="select">选择</a>

</script>

<script type="text/javascript">
    var componentTypeId = "";
    var userInputText = "";//用户搜索的内容
    var oldTableHeight = 580;
    var isopenAttr = false;
    var attrHeight = 0;
    var currentProjectId;
    var currentDeviceId;
    layui.use(['form', 'table', 'layer', 'jquery'],
        function () {
            var form = layui.form;
            var layer = layui.layer;
            var table = layui.table;
            var $ = layui.jquery;
            var order = "";
            var orderType = 0;
            window.loadData = function (parms) {

                var cpIds = [];
                var checks = $("input[type=checkbox]:checked");
                for (var i = 0; i < checks.length; i++) {
                    var attrName = $(checks[i]).attr("AttrName");

                    var attrValue = $(checks[i]).attr("title");
                    cpIds.push({AttrName:attrName,AttrValue:attrValue});
                }
                var catalogId = $("#selCatalog").val();

                if (catalogId == "") {
                    layer.msg("请选择编码库！", { icon: 5 });
                    return;
                }

                table.render({
                    elem: '#tbCommodityCodeList',
                    autoSort: false,
                    method:'post',
                    // url: '/Device/GetDataList' + para + "&" + Math.random()//数据接口
                    url: '/CommodityCodeSelect2/GetCommodityCodeDataList?order='+order+'&orderType='+orderType+'&catalogId='+catalogId+'&inputText='+encodeURIComponent(userInputText)+'&componentTypeId=' + componentTypeId + "&" + Math.random() + parms//数据接口
                    ,where: {compenentCodeIds:cpIds}
                    , page: true //开启分页
                    , limit: 15
                    , limits: [10,15, 20,50]
                    , cols: [[ //表头
                        { field: 'Desc', title: '物资类型', width: 250},
                        { field: 'Code', title: '物资编码', sort: true, width: 250},
                        { field: 'CN_ShortDesc', title: '描述', sort: true },
                         { field: 'right', title: '操作', width: 200, templet: "#barDemo",align:'center' }
                    ]]
                    , id: 'testReload',
                    done: function () {
                        if (attrHeight == 0) {
                            $("#divTable").find(".layui-table-view").first().css("position", null);
                            $("#divTable").find(".layui-table-view").first().css("top", null);
                        } else {
                            $("#divTable").find(".layui-table-view").first().css("position", "absolute");
                            $("#divTable").find(".layui-table-view").first().css("top", 10 + attrHeight);
                        }

                    }
                });
                //监听排序事件
                table.on('sort(useruv)', function(obj){ //注：sort 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
                    console.log(obj.field); //当前排序的字段名
                    console.log(obj.type); //当前排序类型：desc（降序）、asc（升序）、null（空对象，默认排序）
                    console.log(this); //当前排序的 th 对象
                    order = obj.field;
                    if (obj.type == 'desc') {
                        orderType = 1;
                    } else {
                        orderType = 0;
                    }
                    //尽管我们的 table 自带排序功能，但并没有请求服务端。
                    //有些时候，你可能需要根据当前排序的字段，重新向服务端发送请求，从而实现服务端排序，如：
                    table.reload('testReload', {
                        initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。
                        ,   url: '/CommodityCodeSelect2/GetCommodityCodeDataList?order='+order+'&orderType='+orderType+'&catalogId='+catalogId+'&inputText='+encodeURIComponent(userInputText)+'&componentTypeId=' + componentTypeId + "&" + Math.random() + parms//数据接口
                    });

                });

                //监听工具条
                table.on('tool(useruv)', function (obj) {
                    var data = obj.data;
                    var userId = $("#txtUserId").val();
                    if (obj.event === 'attr') {

                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/AttrList?id=' + data.Id + "&" + Math.random(),
                            title: '查看属性',
                            area: ["600px;", "500px;"]
                        });

                    } else if (obj.event === 'select') {
                        if ($("#selProject").val() == null || $("#selProject").val() == "-1") {
                            layer.msg('请选择项目！');
                            return;
                        }
                        if ($("#selDevice").val() == null || $("#selDevice").val() == "-1") {
                            layer.msg('请选择装置！');
                            return;
                        }
                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/CommodityCodePartNumberList?commodityCodeId=' + data.Id + "&userId=" + userId + "&projectId=" + $("#selProject").val() + "&deviceId=" + $("#selDevice").val() + "&" + Math.random(),
                            title: '选择采购码',
                            area: ["800px;", "500px;"]//宽 高
                        });
                    }


                });
            }
            //刷新表格
            window.flush = function () {
                loadData();
            }
            //==============================================打开最近【项目】【装置】分页====================================
          
            window.loadMtoData = function () {
                var mtoId = $("#txtMtoId").val();
                var userId = $("#txtUserId").val();
                table.render({
                    elem: '#mtoTable'
                    , url: "/CommodityCodeSelect/GetUserMaterialTakeOffList?mtoId=&pt=" + Math.random()
                    , page: true //开启分页
                    , limit: 5
                   
                    , limits: [5, 10, 20]
                    , cols: [[
                        { field: 'ProjectName', width: 150, title: '项目', sort: true }
                        , { field: 'DeviceName', width: 150, title: '装置' }
                        , { field: 'Revision', width: 80, title: '版本', sort: true }
                        , { field: 'Version', width: 80, title: '版次' }
                        , { field: 'CheckStatusName', width: 80, title: '状态' }                      
                        , { field: 'LastModifyTime', width: 180, title: '时间', sort: true }                       
                        ,{
                            field: 'CheckStatus', width: 80, title: '操作', templet: function (ent) {     

                                if (ent.CheckStatusName == "已审批" && ent.Approver==userId) {
                                    return "<button class=\"layui-btn layui-btn-danger layui-btn-sm permission\" lay-filter=\"search\" id=\"btnNew\" onclick=projectClick('" + ent.Id + "','" + ent.ProjectId + "','" + ent.DeviceId + "','" + ent.Revision + "','" + ent.Approver + "')>查看</button>";
                                }
                                 if (ent.CheckStatusName == "待审批" && ent.Approver==userId) {
                                    return "<button class=\"layui-btn layui-btn-danger layui-btn-sm permission\" lay-filter=\"search\" id=\"btnNew\" onclick=projectClick('" + ent.Id + "','" + ent.ProjectId + "','" + ent.DeviceId + "','" + ent.Revision + "','" + ent.Approver + "')>审批</button>";
                                }
                               else if (ent.CheckStatusName == "工作中"&& ent.CreateUserId==userId) {
                                    return "<button class=\"layui-btn  layui-btn-sm layui-btn-normal\" lay-filter=\"search\" id=\"btnNew\" onclick=projectClick('" + ent.Id + "','" + ent.ProjectId + "','" + ent.DeviceId + "','" + ent.Revision + "','" + ent.Approver + "')>编辑</button>";
                                }
                                else {
                                    return "";
                                }
                            }}
                    ]]

                });
            }
             

          



            window.openProjectAgain = function () {
                loadMtoData();
                winIndex= layer.open({
                    type: 1,
                    title: '打开最近工作...',
                    area: ['850px', '480px'],
                    minHeight:'200px',
                    content: $('#openShow') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响

                });
            }
            //==============================================打开最近【项目】【装置】分页 end ====================================


            var defaultValue = "@ViewData["projectId"]";
            //select 控件加载完再初始化table
            $("select[name=projectId]").dropdownlist({
                url: "/Device/GetProjectList" + "?pt=" + Math.random(), defaultValue: defaultValue, complete: function () {
                    //loadData();
                }
            });
            //编码库
            $("select[name=selCatalog]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=4&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "first", complete: function () {
                    var value = $("select[name=selCatalog]").val();
                    //物资分类
                    $("select[name=sel200]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=5&parentId="+value+"&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                            form.render();
                            bindEvent();
                        }
                    });
                }
            });
            //项目
            $("select[name=selProject]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
            });
            $("select[name=selProject2]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
            });
            form.render();
            form.on('select(selProject)',
                function(data1) {
                    var value = data1.value;

                    $("select[name=selDevice]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                    //编码库
                    $("select[name=selCatalog]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=4&parentId="+value+"&pt=" + Math.random(), defaultValue: "first", complete: function () {
                        }
                    });

                });
            form.on('select(selProject2)',
                function(data1) {
                    var value = data1.value;
                    $("select[name=selDevice2]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                });
            form.on('checkbox(attrCheck)', function(data) {
                search();
            });
            $("#txtCode").on("input", function (e) {

                if ($("#txtCode").val() == "") {
                    loadCompenetType($("#selCatalog").val());
                    clearAttr();
                    clearTableData();
                }
            });


            //编码库改变
            form.on('select(selCatalog)',
                function (data1) {
                    var value = data1.value;
                    loadCompenetType(value);
                    clearAttr();
                    $("#txtCode").val("");
                    clearTableData();
                });





            form.render();


            window.clearTableData = function() {
                userInputText="清空列表数据";
                loadData();

            }

            window.resetUserInput = function() {
                if (userInputText == "清空列表数据") {
                    userInputText = "";
                }
            }


            var index = 200;
            var ddlCp = $("#divReplaceSel").html();


            //加载物资类型
            window.loadCompenetType = function (compenentTypeId) {
                $("#divCPContainer").html('');
                realDDP(compenentTypeId);
                //清空属性
                clearAttr();
            };

            //加载下一层
            window.loadChildCType = function (sel) {
                clearTableData();
                var name = sel.elem.name;
                var ind = name.replace("sel", "") * 1.0;
                //移除子选项
                for (var i = ind - 1; i > 0; i--) {
                    var div = $("select[name=sel" + i + "]").parent().remove();
                }
                //清空属性
                clearAttr();
                index = ind - 1;
                var value = sel.value;
                //加载下一层
                $.ajax({
                    url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(),
                    type: "get",
                    dataType: "json",
                    success: function (data) {
                        if (data.length > 0) {
                            var sel = ddlCp.replace("{i}", index).replace("{i}", index).replace("{i}", index)
                                .replace("{i}", index);
                            $("#divCPContainer").append(sel);
                            $("select[name=sel" + index + "]").dropdownlist({
                                jsonData: data,
                                defaultValue: "-1"
                            });
                            form.render();
                            bindEvent();
                        } else {
                            loadAttr(value);
                        }


                    },
                    error: function (erorData) {

                    }
                })
            }


            window.realDDP = function (ctId) {
                index = index + 1;
                var catalogId = $("select[name=selCatalog]").val();
                $.ajax({
                    url: "/CommodityCodeSelect2/GetCompenetById?compenentTypeId=" + ctId +"&catalogId="+catalogId,
                    type: 'get',
                    dataTyp: 'json',
                    success: function (data) {
                        if (data.length > 0) {
                            var sel = ddlCp.replace("{i}", index).replace("{i}", index).replace("{i}", index)
                                .replace("{i}", index);
                            $("#divCPContainer").prepend(sel);

                            //项目
                            $("select[name=sel" + index + "]").dropdownlist({
                                jsonData: data,
                                defaultValue: ctId
                            });
                            $.ajax({
                                url: "/CommodityCodeSelect2/GetParentCompenetById?compenentTypeId=" + ctId,
                                type: 'get',
                                dataType: 'json',
                                success: function (data) {
                                    if (data.Success) {
                                        realDDP(data.Data);
                                    } else {
                                        //var last = '<label class="layui-form-label" >物资类型：</label>';
                                        var last = '';
                                        $("#divCPContainer").prepend(last);
                                        form.render();
                                        bindEvent();
                                    }
                                },
                                error: function (errorData) {

                                }
                            });
                        }
                    },
                    error: function (errorData) {

                    }
                });
            }


            window.clearAttr = function() {
                $(".attributeContent").height("1px");
                $("#divAttrContainer").html('');
                attrHeight = 0;
                $("#divTable").find(".layui-table-view").first().css("position", null);
                $("#divTable").find(".layui-table-view").first().css("top",null);
            }

            //加载属性
            window.loadAttr = function (ctId) {
                var label = '<label class="layui-form-label" >{属性}：</label>';
                var checkbox = ' <input type="checkbox" name="" title="{title}" AttrName="{AttrName}" lay-skin="primary"   lay-filter="attrCheck">';
                var divStart = '<div class="layui-inline layui-row layui-col-xs12">';
                var divEnd = '</div>';
                componentTypeId = ctId;
                var divcheboxStart = ' <div class="layui-input-block checkboxContent">';

                clearAttr();
                $.ajax({
                    url: "/CommodityCodeSelect2/GetAttributeByTypeId?compenentTypeId=" + ctId +"&userInputText="+encodeURIComponent(userInputText),
                    type: 'get',
                    dataType: 'json',
                    success: function (data) {

                        if (data.Success) {
                            var result = "";
                            for (var i = 0; i < data.Data.length; i++) {

                                var labelStr = label.replace("{属性}", data.Data[i].AttrbuteName);
                                var checkboxStrs = "";
                                for (var j = 0; j < data.Data[i].AttributeValues.length; j++) {
                                    checkboxStrs += checkbox
                                        .replace("{title}", data.Data[i].AttributeValues[j])
                                        .replace("{AttrName}", data.Data[i].AttrbuteName);
                                }
                                var r = divStart + labelStr + divcheboxStart + checkboxStrs + divEnd + divEnd;
                                result += r;
                            }
                            var head = '<div class="layui-icon layadmin-tabs-control layui-icon-template-1 layui-float-right" style="cursor: pointer" onclick="changeAttrHeight()" id="divMore">展开更多</div>';
                            result = head + result;
                            $("#divAttrContainer").html(result);
                            form.render();
                            search();


                            if (data.Data.length < 3) {
                                attrHeight = data.Data.length * 65;
                            } else {
                                attrHeight = 195;
                            }
                            $(".attributeContent").height(attrHeight + "px");
                            isopenAttr = false;



                            //$(".attributeContent .checkboxContent").unbind("hover");
                            //$(".attributeContent .checkboxContent").hover(function() {
                            //    $(".attributeContent").height("auto");

                            //},function (){
                            //        $(".attributeContent").height(attrHeight + "px");
                            //        //$(".layui-table-body").height(oldTableHeight);
                            //});

                        }
                    },
                    error: function (errorData) {

                    }
                });
            }

            window.changeAttrHeight = function() {
                if (isopenAttr) {
                    $(".attributeContent").height(attrHeight + "px");
                    $("#divMore").html("展开更多");
                } else {
                    $(".attributeContent").height("auto");
                    $("#divMore").html("收起属性");

                }
                isopenAttr = !isopenAttr;
            }

            //绑定下拉框绑定事件
            window.bindEvent = function () {
                form.on('select(cpType)',
                    function (data1) {
                        componentTypeId = data1.value;
                        loadChildCType(data1);
                        userInputText = "";
                    });
            }


            window.search = function () {

                var cpIds = new Array();
                var checks = $("input[type=checkbox]:checked");
                for (var i = 0; i < checks.length; i++) {
                    cpIds.push($(checks[i]).attr("Id"));
                }
                resetUserInput();
                loadData();

            }
                 //==============打开【审批界面】==================
    window.openApprove = function() {
         var mtoId=  $("#txtMtoId").val();
        $.get("/CommodityCodeSelect/GetUserMaterialTakeOff?mtoId=" + mtoId + "&pt=" + Math.random(), function (result) {
            debugger;
                    if (!result.success) {
                        layer.msg(result.message);
                    }
                    else {
                        if (result.data.length >= 0) {
                            var ent = result.data[0];
                             $("#txtRevision").val(ent.revision);
                            $("#txtApproveContent").val(ent.approveContent);
                            var bol = ent.checkStatus == 2 ? true : false;
                            var statusCheckbox = $("input[name='txtcheckStatus']");
                            $('#txtcheckStatus').prop("checked", bol); //注意这里使用的是prop()
                            statusCheckbox.prop('checked', bol); //切换下拉选项时，清空所有选中状态
                            form.render('checkbox');//记得每次操作后要渲染该元素
                            winApproveIndex= layer.open({
                                type: 1,
                                title: '审批意见',
                                area: ['600px', '350px'],
                                minHeight:'200px',
                                content: $('#showApprove') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响

                            });
                        }
                    }
                });
    }

    window.closeApprove =function () {
         layer.close(winApproveIndex);
    }


            window.okApprove = function () {
      //  var isShow = $("#usteel-condition").is(":hidden");

        var id=  $("#txtMtoId").val();
        var revision = $("#txtRevision").val();
        var approveContent = $("#txtApproveContent").val();
        var approveStatus = $("#txtcheckStatus").val();
        debugger;
         var value = 1;
       //获取选中值
        var statusCheckbox = $("input[name='txtcheckStatus']");
       var bol=statusCheckbox.prop('checked');
                if (bol) {
                    value = 2;
                }
        var mto = new Object();
        mto.Id = $("#txtMtoId").val();
        mto.Revision = $("#txtRevision").val();
        mto.ApproveContent = $("#txtApproveContent").val();
         mto.CheckStatus=value;
        $.post("/CommodityCodeSelect/ApproveMto", { mto: mto }, function (data) {
            if (data.success) {//更新数量成功
                          layer.msg("审批成功");
                         layer.close(winApproveIndex);
                    }
                    else {
                         layer.msg(data.message);
            }
               form.render();
                });
    }
    //============审批意见 end==============//


        });
    var winIndex = 0;
    //==============确定【项目】【装置】==================
    function selectProjectDevice() {
        var projectId = $("#selProject2").val();
        var deviceId = $("#selDevice2").val();

        $("#selProject").html($("#selProject2").html());
        $("#selDevice").html($("#selDevice2").html());

        $("#selProject").val(projectId);
        $("#selDevice").val(deviceId);
        layui.form.render('select');
        layer.close(winIndex);

        //编码库
        $("select[name=selCatalog]").dropdownlist({
            url: "/CommodityCodeSelect/GetDropDownData?type=4&parentId=" + $("#selProject2").val() + "&pt=" + Math.random(), defaultValue: "first", complete: function () {
                var value = $("select[name=selCatalog]").val();

                loadCompenetType(value);
                clearAttr();
                $("#txtCode").val("");
                clearTableData();
            }
        });


        $("#lbProject").html($("#selProject2").find("option:selected").text());
        $("#lbDevice").html($("#selDevice2").find("option:selected").text());
        currentProjectId = $("#selProject2").find("option:selected").val();
        currentDeviceId = $("#selDevice2").find("option:selected").val();
        openMaterial();

    }

    //==============确定【项目】【装置】end==================
    //==============选择【项目】【装置】==================
  
    function projectClick(id, projectId, deviceId, revision, approver) {
        
        currentProjectId = projectId;
        currentDeviceId = deviceId;      
        if (approver != $("#txtUserId").val()) {
            $("#divApprove").hide();
        }
        else {
             $("#divApprove").show();
        }
        $("#selProject").val(projectId);
        $("#txtMtoId").val(id);
        $("#txtRevision").val(revision);
        layui.form.render('select');
        $.get("/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + projectId + "&pt=" + Math.random(), function (result) {
            //<option value="-1">全部</option>
            if (result != null && result.length > 0) {
                var optionHtml = "";
                for (var i = 0; i < result.length; i++) {
                    optionHtml += "<option value="+result[i].value+">"+result[i].text+"</option>";
                }
                $("#selDevice").html(optionHtml);
                $("#selDevice").val(deviceId);
                layui.form.render('select');


                //刷新编码库
                $("#lbProject").html($("#selProject").find("option:selected").text());
                $("#lbDevice").html($("#selDevice").find("option:selected").text());
                currentProjectId = $("#selProject").find("option:selected").val();
                currentDeviceId = $("#selDevice").find("option:selected").val();

                openMaterial();
                //编码库
                $("select[name=selCatalog]").dropdownlist({
                    url: "/CommodityCodeSelect/GetDropDownData?type=4&parentId=" + $("#selProject").val() + "&pt=" + Math.random(), defaultValue: "first", complete: function () {
                        var value = $("select[name=selCatalog]").val();

                        loadCompenetType(value);
                        clearAttr();
                        $("#txtCode").val("");
                        clearTableData();
                    }
                });
                selectProjectDevice();
            }
            layer.close(winIndex);
           
        });
        layer.close(winIndex);






    }
    //==============选择【项目】【装置】end==================
    //==============打开【拷贝】==================
    function copy() {
         var projectId = $("#selProject").val();
        var deviceId = $("#selDevice").val();
        layer.open({
            type: 2,
            content: '/CommodityCodeSelect/CopyIndex?projectId='+projectId+"&deviceId=" +deviceId+"&"+ Math.random(),
            title: '拷贝',
            area: ["1000px;", "700px;"]//宽 高
        });
    }
    //==============打开【拷贝】end==================
     //==============打开【查看料表】==================
    function openReoprt() {
        
        var projectId = $("#selProject").val();
        var deviceId = $("#selDevice").val();
        if (projectId == null) {
            projectId = currentProjectId;
        }
         if (deviceId == null) {
            deviceId = currentDeviceId;
        }
        var mtoId= $("#txtMtoId").val();
        if ((projectId == -1 || projectId == "" || projectId == null) || (deviceId == -1 || deviceId == "" || deviceId == null)) {
            layer.msg("【项目】和【装置】必须选择");
            return;
        }
        layer.open({
            type: 2,
            content: '/CommodityCodeSelect/ReportIndex?mtoId='+mtoId+'&projectId=' + projectId + "&deviceId=" + deviceId + "&" + Math.random(),
            title: '选择采购码',
            area: ["1150px;", "700px;"]//宽 高
        });
    }
    //==============打开【查看料表】end==================

    //==============显示隐藏属性=========//

    function changeVisivility() {
        var isShow = $("#usteel-condition").is(":hidden");
        if (isShow) {
            $("#usteel-condition").show();
            $("#collaIcon").html(" &#xe61a; ");

        }
        else {
            $("#usteel-condition").hide();
            $("#collaIcon").html(" &#xe602; ");
        }
    }
    //============显示隐藏属性end==============//
</script>



<script type="text/javascript">   
    window.onload = function () {
        window.openProjectAgain();
    }
    //页面加载
    $("#txtCode").autocomplete({
        source: function (request, response) {

            var name = $.ui.autocomplete.escapeRegex(request.term);
            userInputText = name;
            setTimeout(function () {
                response($.grep(source(name), function (item) {
                    return item;
                }));
            }, 1000);
        },
        select: function (data) {
            setTimeout(function () {
                var index = selectList.indexOf($("#txtCode").val());
                //当前选中的Id
                var compenentTypeId = selectIds[index];
                loadCompenetType(compenentTypeId);
                loadAttr(compenentTypeId);


            }, 100);
        }
    });

    var selectList = new Array();
    var selectIds = new Array();
    //利用ajax根据输入的到数据库查找 相当于
    function source(name) {
        console.log(name);

        var desc = name;
        var catalogId = $("select[name=selCatalog]").val();
        var result = new Array();

        $.ajax({
            url: "/CommodityCodeSelect2/GetCompenetTypeByMCDesc?desc=" +
                encodeURIComponent(desc) +
                "&catalogId=" +
                catalogId,
            type: "get",
            async: false,
            dataType: "json",
            success: function (data) {
                if (dealResult(data)) {
                    for (var i = 0; i < data.Data.length; i++) {
                        selectIds[i] = data.Data[i].ComponentTypeId;
                        result[i] = data.Data[i].ComponentTypeCode + "-" + data.Data[i].ComponentTypeDesc + "(" + data.Data[i].Count + ")";
                    }
                }
            }
        });
        selectList = result;
        return result;
    }

    function openMaterial() {

        var projectId = currentProjectId;
        var deviceId = currentDeviceId;    
        $.cookie('projectIdcd', projectId, { path: '/', secure: false });
        $.cookie('deviceIdcd', deviceId, { path: '/', secure: false });
        //$.cookie('projectId', projectId);
        $.cookie('mtoId', $("#txtMtoId").val(), { path: '/', secure: false });

        parent.locationPage('管理料表');
    }
</script>



