
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Body.cshtml";
}
<style>
    .selType {
        display: none;
    }
    .layui-form-label {
        width: 100px;
    }
</style>

<link href="~/js/jquery-ui.css" rel="stylesheet" />
<script src="~/js/jquery-ui.js"></script>

<link rel="stylesheet" type="text/css" href="~/lib/usteel-search/search.css?t=@DateTime.Now" />
<script type="text/javascript" src="~/lib/usteel-search/search.js?t=@DateTime.Now"></script>
<div class="layui-form" action="" id="searchForm">
    <div class="layui-form-item search">
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label">项目：</label>
            <div class="layui-input-inline">
                <select lay-search id="selProject" name="selProject" lay-filter="selProject"></select>
            </div>
        </div>
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label">装置：</label>
            <div class="layui-input-inline">
                <select lay-search id="selDevice" name="selDevice" lay-filter="selDevice"></select>
            </div>
        </div>
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label" style="width: auto;">物资类型</label>
            <div class="layui-input-inline">
                <input type="text" name="txtCode" class="layui-input" id="txtCode" style="width:100%" />
            </div>

        </div>
        <div class="layui-inline " style="width:500px">
            <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="loadData()">搜索</button>
        </div>
        <div class="layui-inline layui-float-rigth" style="float:right">
            <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="openReoprt()">查看物料表</button>
        </div>
    </div>
    @*物资类型*@
    <div class="layui-form-item search">
        <div class="layui-inline" id="divCPContainer">
            <label class="layui-form-label">物资类型：</label>
            <div class="layui-input-inline" id="divsel200">
                <select lay-search name="sel200" lay-filter="cpType"></select>
            </div>
        </div>
       
    </div>
    @*属性值列表*@
    <div class="layui-form-item search" id="divAttrContainer">


    </div>



</div>

<div style="display: none" id="divReplaceSel">
    <div class="layui-input-inline" id="divsel{i}" index="{i}">
        <select lay-search name="sel{i}" lay-filter="cpType"></select>
    </div>
</div>

<input type="hidden" id="txtUserId" name="txtUserId" value="@ViewData["UserId"]" />
<input type="hidden" id="txtComponentTypeId" name="txtComponentTypeId" value="" />
<input type="hidden" id="txtMtoId" name="txtMtoId" value="" />
<table class="layui-table" lay-data="{height: 'full-200', cellMinWidth: 80}" id="tbCommodityCodeList" lay-filter="useruv"></table>
<div class="layui-form" action="" id="openShow" style="display:none">
    <table class="layui-table" id="projectDevice">
        <colgroup>
            <col width="150">
            <col width="150">
            <col width="200">
            <col>
        </colgroup>
        <thead>
            <tr>
                <th>项目</th>
                <th>装置</th>
                <th>版次</th>
                <th>状态</th>
                <th>时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="trody"></tbody>
    </table>
    <div class="layui-layer-title" style="cursor: move;">新建工作...</div>
    <div class="layui-form" action="" id="searchForm2">
        <div class="layui-form-item search">
            <div class="layui-inline layui-float-left">
                <label class="layui-form-label">项目：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selProject2" name="selProject2" lay-filter="selProject2"></select>
                </div>
            </div>
            <div class="layui-inline layui-float-left">
                <label class="layui-form-label">装置：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selDevice2" name="selDevice2" lay-filter="selDevice2"></select>
                </div>
            </div>
            <div class="layui-inline ">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnOk" onclick="selectProjectDevice()">确定</button>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-sm permission" action="8" lay-event="attr">查看属性</a>
    <a class="layui-btn layui-btn-sm layui-btn-normal permission" action="2" lay-event="select">选择</a>

</script>

<script type="text/javascript">
    var componentTypeId="";
    layui.use(['form', 'table', 'layer', 'jquery'],
        function () {
            var form = layui.form;
            var layer = layui.layer;
            var table = layui.table;
            var $ = layui.jquery;


            window.loadData = function (parms) {
                
                var cpIds = [];
                var checks = $("input[type=checkbox]:checked");
                for (var i = 0; i < checks.length; i++) {
                    var attrName = $(checks[i]).attr("AttrName");
                    var attrValue = $(checks[i]).attr("title");
                    cpIds.push({AttrName:attrName,AttrValue:attrValue});
                }

                table.render({
                    elem: '#tbCommodityCodeList',
                    height: 'full-80',
                    method:'post',
                    // url: '/Device/GetDataList' + para + "&" + Math.random()//数据接口
                    url: '/CommodityCodeSelect/GetCommodityCodeDataList?componentTypeId=' + componentTypeId + "&" + Math.random() + parms//数据接口
                    ,where: {compenentCodeIds:cpIds}
                    , page: true //开启分页
                    , limit: 15
                    , limits: [15,50, 100]
                    , cols: [[ //表头
                        { field: 'Desc', title: '物资类型' },
                        { field: 'Code', title: '物资编码' }
                        , { field: 'CN_ShortDesc', title: '描述' }
                        , { field: 'right', title: '操作', width: 460, templet: "#barDemo",align:'center' }
                    ]]
                    , id: 'testReload',

                });

                //监听工具条
                table.on('tool(useruv)', function (obj) {
                    var data = obj.data;
                    var userId = $("#txtUserId").val();
                    if (obj.event === 'attr') {

                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/AttrList?id=' + data.Id + "&" + Math.random(),
                            title: '查看属性',
                            area: ["600px;", "500px;"]
                        });

                    } else if (obj.event === 'delete') {
                        layer.confirm('确定删除吗', function (index) {
                            $.ajax({
                                url: '/Device/DeleteById?id=' + data.Id + "&" + Math.random(),
                                dataType: "json",
                                success: function (data) {
                                    if (data.Success) {
                                        layer.msg("删除成功");
                                        loadData();
                                    } else {
                                        layer.msg("删除失败", { icon: 5 });
                                    }
                                }
                            });
                        });
                    } else if (obj.event === 'select') {
                        if ($("#selProject").val() == null || $("#selProject").val() == "-1") {
                            layer.msg('请选择项目！');
                            return;
                        }
                        if ($("#selDevice").val() == null || $("#selDevice").val() == "-1") {
                            layer.msg('请选择装置！');
                            return;
                        }
                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/CommodityCodePartNumberList?commodityCodeId=' + data.Id + "&userId=" + userId + "&projectId=" + $("#selProject").val() + "&deviceId=" + $("#selDevice").val() + "&" + Math.random(),
                            title: '选择采购码',
                            area: ["800px;", "500px;"]//宽 高
                        });
                    }


                });
            }
            //刷新表格
            window.flush = function () {
                loadData();
            }
            openProject();//打开最近【项目】【装置】

            var defaultValue = "@ViewData["projectId"]";
            //select 控件加载完再初始化table
            $("select[name=projectId]").dropdownlist({
                url: "/Device/GetProjectList" + "?pt=" + Math.random(), defaultValue: defaultValue, complete: function () {
                    loadData();
                }
            });
            //项目
            $("select[name=selProject]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
            });
            $("select[name=selProject2]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
            });
            form.render();
            form.on('select(selProject)',
                function(data1) {
                    var value = data1.value;
                    $("select[name=selDevice]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                });
            form.on('select(selProject2)',
                function(data1) {
                    var value = data1.value;
                    $("select[name=selDevice2]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                });

            form.render();


            //==============打开【最近项目，装置】==================

            function openProject() {
                $.get("/CommodityCodeSelect/GetUserMaterialTakeOff?id=&pt=" + Math.random(), function (result) {
                    if (!result.success) {
                        layer.msg(result.message);
                    }
                    else {
                        if (result.data.length > 0) {
                            var tr= "";
                            for (var i = 0; i < result.data.length; i++) {
                                var ent = result.data[i];

                                tr += "<tr>";
                                tr += "<td><a onclick=projectClick('"+ ent.id +"','"+ ent.projectId +"','"+ ent.deviceId + "')>"+ ent.projectName + "</a></td>";
                                tr += "<td>"+ent.deviceName+"</td>";
                                tr += "<td>"+ent.version+"</td>";
                                tr += "<td>"+ent.checkStatusName+"</td>";
                                tr += "<td>" + ent.timeString + "</td>";
                                tr += "<td> <button class=\"layui-btn layui-btn-normal\" lay-filter=\"search\" id=\"btnNew\" onclick=projectClick('"+ ent.id +"','" + ent.projectId + "','" + ent.deviceId + "')>选择</button></td>";
                                tr += " </tr>";
                            }
                            $("#trody").append(tr);
                            winIndex= layer.open({
                                type: 1,
                                title: '打开最近工作...',
                                area: ['800px', '600px'],
                                minHeight:'200px',
                                content: $('#openShow') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                                //,btn: ['按钮一', '按钮二', '按钮三']
                                //,yes: function(index, layero){
                                //  //按钮【按钮一】的回调
                                //}
                                //,btn2: function(index, layero){
                                //  //按钮【按钮二】的回调

                                //    return false; 开启该代码可禁止点击该按钮关闭
                                //}
                                //,btn3: function(index, layero){
                                //  //按钮【按钮三】的回调

                                //  //return false 开启该代码可禁止点击该按钮关闭
                                //}
                                //,cancel: function(){
                                //  //右上角关闭回调

                                //  //return false 开启该代码可禁止点击该按钮关闭
                                //}
                            });
                        }
                    }
                });

            }
            //==============打开【最近项目，装置】end==================



            //物资分类
            $("select[name=sel200]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                    form.render();
                    bindEvent();
                }
            });
            var index = 200;
            var ddlCp = $("#divReplaceSel").html();


            //加载物资类型
            window.loadCompenetType = function (compenentTypeId) {
                $("#divCPContainer").html('');
                realDDP(compenentTypeId);
            };

            //加载下一层
            window.loadChildCType = function (sel) {
                var name = sel.elem.name;
                var ind = name.replace("sel", "") * 1.0;
                //移除子选项
                for (var i = ind - 1; i > 0; i--) {
                    var div = $("select[name=sel" + i + "]").parent().remove();
                }
                //清空属性
                $("#divAttrContainer").html('');
                index = ind - 1;
                var value = sel.value;
                //加载下一层
                $.ajax({
                    url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(),
                    type: "get",
                    dataType: "json",
                    success: function (data) {
                        if (data.length > 0) {
                            var sel = ddlCp.replace("{i}", index).replace("{i}", index).replace("{i}", index)
                                .replace("{i}", index);
                            $("#divCPContainer").append(sel);
                            $("select[name=sel" + index + "]").dropdownlist({
                                jsonData: data,
                                defaultValue: "-1"
                            });
                            form.render();
                            bindEvent();
                        } else {
                            loadAttr(value);
                        }


                    },
                    error: function (erorData) {

                    }
                })
            }


            window.realDDP = function (ctId) {
                index = index + 1;
                $.ajax({
                    url: "/CommodityCodeSelect2/GetCompenetById?compenentTypeId=" + ctId,
                    type: 'get',
                    dataTyp: 'json',
                    success: function (data) {
                        if (data.length > 0) {
                            var sel = ddlCp.replace("{i}", index).replace("{i}", index).replace("{i}", index)
                                .replace("{i}", index);
                            $("#divCPContainer").prepend(sel);

                            //项目
                            $("select[name=sel" + index + "]").dropdownlist({
                                jsonData: data,
                                defaultValue: ctId
                            });
                            $.ajax({
                                url: "/CommodityCodeSelect2/GetParentCompenetById?compenentTypeId=" + ctId,
                                type: 'get',
                                dataType: 'json',
                                success: function (data) {
                                    if (data.Success) {
                                        realDDP(data.Data);
                                    } else {
                                        var last = '<label class="layui-form-label" >物资类型：</label>';
                                        $("#divCPContainer").prepend(last);
                                        form.render();
                                        bindEvent();
                                    }
                                },
                                error: function (errorData) {

                                }
                            });
                        }
                    },
                    error: function (errorData) {

                    }
                });
            }

            //加载属性
            window.loadAttr = function (ctId) {
                var label = '<label class="layui-form-label" >{属性}：</label>';
                var checkbox = ' <input type="checkbox" name="" title="{title}" Id="{AttrName}" lay-skin="primary">';
                var divStart = '<div class="layui-inline layui-row layui-col-xs12">';
                var divEnd = '</div>';
                componentTypeId = ctId;
                var divcheboxStart = ' <div class="layui-input-block">';

                $("#divAttrContainer").html('');
                $.ajax({
                    url: "/CommodityCodeSelect2/GetAttributeByTypeId?compenentTypeId=" + ctId,
                    type: 'get',
                    dataType: 'json',
                    success: function (data) {

                        if (data.Success) {
                            var result = "";
                            for (var i = 0; i < data.Data.length; i++) {

                                var labelStr = label.replace("{属性}", data.Data[i].AttrbuteName);
                                var checkboxStrs = "";
                                for (var j = 0; j < data.Data[i].AttributeValueModels.length; j++) {
                                    checkboxStrs += checkbox
                                        .replace("{title}", data.Data[i].AttributeValueModels[j].Value)
                                        .replace("{AttrName}", data.Data[i].AttrbuteName);
                                }
                                var r = divStart + labelStr + divcheboxStart + checkboxStrs + divEnd + divEnd;
                                result += r;
                            }
                            $("#divAttrContainer").html(result);
                            form.render();
                        }
                    },
                    error: function (errorData) {

                    }

                });


            }

            //绑定下拉框绑定事件
            window.bindEvent = function () {
                form.on('select(cpType)',
                    function (data1) {
                        componentTypeId = data1.value;
                        loadChildCType(data1);
                    });
            }


            window.search = function () {
                var cpIds = new Array();
                var checks = $("input[type=checkbox]:checked");
                for (var i = 0; i < checks.length; i++) {
                    cpIds.push($(checks[i]).attr("Id"));
                }
            }
        });
    var winIndex = 0;
    //==============确定【项目】【装置】==================
    function selectProjectDevice() {
        var projectId = $("#selProject2").val();
        var deviceId = $("#selDevice2").val();
        $("#selProject").html($("#selProject2").html());
        $("#selDevice").html($("#selDevice2").html());

        $("#selProject").val(projectId);
        $("#selDevice").val(deviceId);
        layui.form.render('select');
        layer.close(winIndex);
    }
    //==============确定【项目】【装置】end==================
    //==============选择【项目】【装置】==================
    function projectClick(id,projectId, deviceId) {
        $("#selProject").val(projectId);
        $("#txtMtoId").val(id);
        layui.form.render('select');
        $.get("/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + projectId + "&pt=" + Math.random(), function (result) {
            //<option value="-1">全部</option>
            if (result != null && result.length > 0) {
                var optionHtml = "";
                for (var i = 0; i < result.length; i++) {
                    optionHtml += "<option value="+result[i].value+">"+result[i].text+"</option>";
                }
                $("#selDevice").html(optionHtml);
                $("#selDevice").val(deviceId);
                layui.form.render('select');
            }
            layer.close(winIndex);
        });
        layer.close(winIndex);
    }
    //==============选择【项目】【装置】end==================
    //==============打开【查看料表】==================
    function openReoprt() {
        var projectId = $("#selProject").val();
        var deviceId = $("#selDevice").val();
        var mtoId= $("#txtMtoId").val();
        if ((projectId == -1 || projectId == "" || projectId == null) || (deviceId == -1 || deviceId == "" || deviceId == null)) {
            layer.msg("【项目】和【装置】必须选择");
            return;
        }
        layer.open({
            type: 2,
            content: '/CommodityCodeSelect/ReportIndex?mtoId='+mtoId+'&projectId=' + projectId + "&deviceId=" + deviceId + "&" + Math.random(),
            title: '选择采购码',
            area: ["1000px;", "700px;"]//宽 高
        });
    }
    //==============打开【查看料表】end==================
    //==============显示隐藏属性=========//

    function changeVisivility() {
        var isShow = $("#usteel-condition").is(":hidden");
        if (isShow) {
            $("#usteel-condition").show();
            $("#collaIcon").html(" &#xe61a; ");

        }
        else {
            $("#usteel-condition").hide();
            $("#collaIcon").html(" &#xe602; ");
        }
    }
    //============显示隐藏属性end==============//
</script>



<script type="text/javascript">
    //页面加载
    $("#txtCode").autocomplete({
        source: function (request, response) {
            var name = $.ui.autocomplete.escapeRegex(request.term);
            response($.grep(source(name), function (item) {
                return item;
            }));
        },
        select: function (data) {
            setTimeout(function () {
                var index = selectList.indexOf($("#txtCode").val());
                //当前选中的Id
                var compenentTypeId = selectIds[index];
                loadCompenetType(compenentTypeId);
                loadAttr(compenentTypeId);
            }, 100);
        }
    });

    var selectList = new Array();
    var selectIds = new Array();
    //利用ajax根据输入的到数据库查找 相当于
    function source(name) {
        console.log(name);
        var desc = name;
        var projectId = $("select[name=selProject]").val();
        var result = new Array();
        $.ajax({
            url: "/CommodityCodeSelect2/GetCompenetTypeByMCDesc?desc=" +
                encodeURIComponent(desc) +
                "&projectId=" +
                projectId,
            type: "get",
            async: false,
            dataType: "json",
            success: function (data) {
                if (dealResult(data)) {
                    for (var i = 0; i < data.Data.length; i++) {
                        selectIds[i] = data.Data[i].ComponentTypeId;
                        result[i] = data.Data[i].ComponentTypeDesc + "(" + data.Data[i].Count + ")";
                    }
                }
            }
        });
        selectList = result;
        return result;
    }
</script>

