
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout_Body.cshtml";
}
<style>
    .selType {
        display: none;
    }
</style>
<link rel="stylesheet" type="text/css" href="~/lib/usteel-search/search.css?t=@DateTime.Now" />
<script type="text/javascript" src="~/lib/usteel-search/search.js?t=@DateTime.Now"></script>
<div class="layui-form" action="" id="searchForm">
    <div class="layui-form-item search">
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label">项目：</label>
            <div class="layui-input-inline">
                <select lay-search id="selProject" name="selProject" lay-filter="selProject"></select>
            </div>
        </div>
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label">装置：</label>
            <div class="layui-input-inline">
                <select lay-search id="selDevice" name="selDevice" lay-filter="selDevice"></select>
            </div>
        </div>
        <div class="layui-inline layui-float-left">
            <label class="layui-form-label" style="width: auto;">物资类型</label>
            <div class="layui-input-inline">
                <input type="text" name="txtCode" class="layui-input" id="txtCode" style="width:100%" />
            </div>

        </div>
        <div class="layui-inline " style="width:500px">
            <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="loadData()">搜索</button>
        </div>
        <div class="layui-inline layui-float-rigth" style="float:right">
            <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnSearch" onclick="openReoprt()">查看物料表</button>
        </div>
    </div>
    <div class="layui-collapse" lay-filter="test">
        <div class="layui-colla-item">
            <div class="layui-form-item search">
                <div class="layui-inline">
                    <div class="layui-input-inline" style="width:110px; padding-left:10px;" onclick="changeVisivility()">
                        <div style="padding-top:8px;"> <i id="collaIcon" class="layui-icon"> &#xe602; </i> 物资类型：</div>                       
                    </div>
                  

                    <div class="layui-input-inline" id="divsel1">
                        <select lay-search name="sel1" lay-filter="sel1"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel2">
                        <select lay-search name="sel2" lay-filter="sel2"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel3">
                        <select lay-search name="sel3" lay-filter="sel3"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel4">
                        <select lay-search name="sel4" lay-filter="sel4"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel5">
                        <select lay-search name="sel5" lay-filter="sel5"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel6">
                        <select lay-search name="sel6" lay-filter="sel6"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel7">
                        <select lay-search name="sel7" lay-filter="sel7"></select>
                    </div>
                    <div class="layui-input-inline  selType" id="divsel8">
                        <select lay-search name="sel8" lay-filter="sel8"></select>
                    </div>
                    <div class="layui-input-inline  selType" id="divsel9">
                        <select lay-search name="sel9" lay-filter="sel9"></select>
                    </div>
                    <div class="layui-input-inline selType" id="divsel10">
                        <select lay-search name="sel10" lay-filter="sel10"></select>
                    </div>

                </div>

            </div>

            <div class="layui-colla-content layui-show">
                <!--  <div id="attrDiv" class="usteel-content w" style="width: 99%;padding: 0px 5px 0px 5px;border: 1px;border-style: solid;border-color: darkgray;display:none">-->
                <div class="usteel-condition" id="usteel-condition" style="padding:0px">
                    <div class="selector" lay-filter="chapterRender">
                        <!-- 多选属性区域 -->
                    </div>
                </div>

                <!--</div>-->
            </div>
        </div>



    </div>



</div>
<input type="hidden" id="txtUserId" name="txtUserId" value="@ViewData["UserId"]" />
<input type="hidden" id="txtComponentTypeId" name="txtComponentTypeId" value="" />
<input type="hidden" id="txtMtoId" name="txtMtoId" value="" />
<table class="layui-table" lay-data="{height: 'full-200', cellMinWidth: 80}" id="tbCommodityCodeList" lay-filter="useruv"></table>
<div class="layui-form" action="" id="openShow" style="display:none">
    <table class="layui-table" id="projectDevice">
        <colgroup>
            <col width="150">
            <col width="150">
            <col width="200">
            <col>
        </colgroup>
        <thead>
            <tr>
                <th>项目</th>
                <th>装置</th>
                <th>版次</th>
                <th>状态</th>
                <th>时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="trody"></tbody>
    </table>
    <div class="layui-layer-title" style="cursor: move;">新建工作...</div>
    <div class="layui-form" action="" id="searchForm2">
        <div class="layui-form-item search">
            <div class="layui-inline layui-float-left">
                <label class="layui-form-label">项目：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selProject2" name="selProject2" lay-filter="selProject2"></select>
                </div>
            </div>
            <div class="layui-inline layui-float-left">
                <label class="layui-form-label">装置：</label>
                <div class="layui-input-inline">
                    <select lay-search id="selDevice2" name="selDevice2" lay-filter="selDevice2"></select>
                </div>
            </div>
            <div class="layui-inline ">
                <button class="layui-btn layui-btn-normal" lay-filter="search" id="btnOk" onclick="selectProjectDevice()">确定</button>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-sm permission" action="8" lay-event="attr">查看属性</a>
    <a class="layui-btn layui-btn-sm layui-btn-normal permission" action="2" lay-event="select">选择</a>

</script>

<script type="text/javascript">

    layui.use(['form', 'table', 'layer', 'jquery'],
        function () {
            var form = layui.form;
            var layer = layui.layer;
            var table = layui.table;
            var $ = layui.jquery;


            window.loadData = function (parms) {
                var componentTypeId=$("#txtComponentTypeId").val();
                var para = getSearchCondition("searchForm");
                table.render({
                    elem: '#tbCommodityCodeList',
                    height: 'full-80',
                    // url: '/Device/GetDataList' + para + "&" + Math.random()//数据接口
                    url: '/CommodityCodeSelect/GetCommodityCodeDataList' + para + "&componentTypeId="+componentTypeId+"&" + Math.random() + parms//数据接口
                    , page: true //开启分页
                    , limit: 15
                    , limits: [15,50, 100]
                    , cols: [[ //表头
                        { field: 'Desc', title: '物资类型' },
                        { field: 'Code', title: '物资编码' }
                        , { field: 'CN_ShortDesc', title: '描述' }
                        , { field: 'right', title: '操作', width: 460, templet: "#barDemo",align:'center' }
                    ]]
                    , id: 'testReload',

                });

                //监听工具条
                table.on('tool(useruv)', function (obj) {
                    var data = obj.data;
                    var userId = $("#txtUserId").val();
                    if (obj.event === 'attr') {

                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/AttrList?id=' + data.Id + "&" + Math.random(),
                            title: '查看属性',
                            area: ["600px;", "500px;"]
                        });

                    } else if (obj.event === 'delete') {
                        layer.confirm('确定删除吗', function (index) {
                            $.ajax({
                                url: '/Device/DeleteById?id=' + data.Id + "&" + Math.random(),
                                dataType: "json",
                                success: function (data) {
                                    if (data.Success) {
                                        layer.msg("删除成功");
                                        loadData();
                                    } else {
                                        layer.msg("删除失败", { icon: 5 });
                                    }
                                }
                            });
                        });
                    } else if (obj.event === 'select') {
                        if ($("#selProject").val() == null || $("#selProject").val() == "-1") {
                            layer.msg('请选择项目！');
                            return;
                        }
                         if ($("#selDevice").val() == null || $("#selDevice").val() == "-1") {
                            layer.msg('请选择装置！');
                            return;
                        }
                        layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/CommodityCodePartNumberList?commodityCodeId=' + data.Id + "&userId=" + userId + "&projectId=" + $("#selProject").val() + "&deviceId=" + $("#selDevice").val() + "&" + Math.random(),
                            title: '选择采购码',
                            area: ["800px;", "500px;"]//宽 高
                        });
                    }


                });
            }
            //刷新表格
            window.flush = function () {
                loadData();
              }
            openProject();//打开最近【项目】【装置】

            var defaultValue = "@ViewData["projectId"]";
            //select 控件加载完再初始化table
            $("select[name=projectId]").dropdownlist({
                url: "/Device/GetProjectList" + "?pt=" + Math.random(), defaultValue: defaultValue, complete: function () {
                    loadData();
                }
            });
            //项目
              $("select[name=selProject]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
              });
              $("select[name=selProject2]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=1&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
              });
             form.render();
             form.on('select(selProject)',
                function(data1) {
                    var value = data1.value;
                    $("select[name=selDevice]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                 });
             form.on('select(selProject2)',
                function(data1) {
                    var value = data1.value;
                    $("select[name=selDevice2]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            //if ($("select[name=sel2]").val() != "") {
                            //    $("#divsel2").show();
                            //}
                        }
                    });
                });
            //物资分类
            $("select[name=sel1]").dropdownlist({
                url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=00000000-0000-0000-0000-000000000000&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                }
            });
            form.render();
            form.on('select(sel1)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(1);
                     if (value == -1) {
                        getTypeAttr(value);
                        return;
                    }
                    $("select[name=sel2]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {
                            selDropdownlist(2,value);
                        }
                    });
                });
            form.on('select(sel2)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(2);
                     if (value == -1) {
                       var parentValue = $("select[name=sel1]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel3]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                             selDropdownlist(3,value);
                        }
                    });
                });
            form.on('select(sel3)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(3);
                     if (value == -1) {
                       var parentValue = $("select[name=sel2]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel4]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                             selDropdownlist(4,value);
                        }
                    });
                });
            form.on('select(sel4)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(4);
                     if (value == -1) {
                       var parentValue = $("select[name=sel3]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel5]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                             selDropdownlist(5,value);
                        }
                    });
                });
            form.on('select(sel5)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(5);
                      if (value == -1) {
                       var parentValue = $("select[name=sel4]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel6]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            selDropdownlist(6,value);
                        }
                    });
                });
            form.on('select(sel6)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(6);
                     if (value == -1) {
                       var parentValue = $("select[name=sel5]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel7]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                             selDropdownlist(7,value);
                        }
                    });
                });
            form.on('select(sel7)',
                function(data1) {
                    var value = data1.value;
                    hidDropdownlist(7);
                     if (value == -1) {
                       var parentValue = $("select[name=sel6]").val();
                        getTypeAttr(parentValue);
                        return;
                    }
                    $("select[name=sel8]").dropdownlist({
                        url: "/CommodityCodeSelect/GetDropDownData?type=3&parentId=" + value + "&pt=" + Math.random(), defaultValue: "-1", complete: function () {

                            selDropdownlist(8,value);
                        }
                    });
                });
            //==============获取【物资类型】属性==================
            function getTypeAttr(id) {

                if (id == "-1") {
                    $("#txtComponentTypeId").val("");
                }
                else {
                    $("#txtComponentTypeId").val(id);
                }
                $.get("/CommodityCodeSelect/GetTypeAttributeList?id=" + id + "&pt=" + Math.random(), function (result) {
                 if (result.length == 0) {
                     layer.msg("获取不到属性");
                     $(".selector").html("");
                     $("#usteel-condition").hide();
                 }
                 else {
                     var html = "";
                     for (var i = 0; i < result.length; i++) {
                         var attributeName = result[i].attributeName;
                         var valuelist = result[i].valueList;
                         html += "<div class='usteel-search' data_type='"+attributeName+"'>";
                         html += "<div class='sl-key'>";
                         html += "<strong>"+attributeName+"：</strong>";
                         html += "</div>";
                         html += "<div class='sl-value'>";
                         html += "<div class='sl-v-list'>";
                         html += "<ul>";
                         if (valuelist != null && valuelist.length > 0) {
                             for (var k = 0; k < valuelist.length; k++) {
                                 //var id = valuelist[k].componenttypeid;//物资类型ID
                                 var value = valuelist[k];
                                 html += "<li data_id='"+value+"'>";
                                 html += "<a href='javascript:;'>";
                                 html += "<i class=''></i><span>"+value+"</span>";
                                 html += "</a>";
                                 html += "</li>";

                             }
                         }
                         html += "</ul>";
                         html += "</div>";
                         html += "<div class='sl-btns'>";
                         html += "<a href='JavaScript:;' class='btn btn-primary disabled'>确定</a>";
                         html += "<a href='JavaScript:;' class='btn btn-default'>取消</a>";
                         html += "</div>";
                         html += "</div>";
                         html += "<div class='sl-ext'>";
                         html += "<a href='JavaScript:;' class='sl-b-more' style='visibility: hidden;'><i class='layui-icon layui-icon-down'></i>更多</a>";
                         html += "<a href='JavaScript:;' class='sl-b-multiple'><i class='layui-icon layui-icon-add-1'></i>多选</a>";
                         html += "</div>";
                         html += "</div>";
                     }
                     $(".selector").html(html);
                     $("#usteel-condition").show();
                    // form.render('chapterRender');///重新渲染select#chapterId
                      layui.use('form', function() {
                        var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                        form.render();
                    });
                   }
                   loadData();
             });
            }
            function selDropdownlist(n,parentValue) {
                var childValue = $("select[name=sel"+n+"]").val();
                if (childValue != "" && $("select[name=sel"+n+"]").find("option").length > 0) {
                    $("#divsel"+n+"").show();
                    if (childValue != -1 && childValue != null) {
                        getTypeAttr(childValue);
                    }
                    else {
                        getTypeAttr(parentValue);
                    }
                }
                else {
                    getTypeAttr(parentValue);
                }
            }
            //==============获取【物资类型】属性end==================
            //==============打开【最近项目，装置】==================

            function openProject() {
                $.get("/CommodityCodeSelect/GetUserMaterialTakeOff?id=&pt=" + Math.random(), function (result) {
                    if (!result.success) {
                        layer.msg(result.message);
                    }
                    else {
                        if (result.data.length > 0) {
                            var tr= "";
                            for (var i = 0; i < result.data.length; i++) {
                                var ent = result.data[i];

                                tr += "<tr>";
                                tr += "<td><a onclick=projectClick('"+ ent.id +"','"+ ent.projectId +"','"+ ent.deviceId + "')>"+ ent.projectName + "</a></td>";
                                tr += "<td>"+ent.deviceName+"</td>";
                                tr += "<td>"+ent.version+"</td>";
                                tr += "<td>"+ent.checkStatusName+"</td>";
                                tr += "<td>" + ent.timeString + "</td>";
                                tr += "<td> <button class=\"layui-btn layui-btn-normal\" lay-filter=\"search\" id=\"btnNew\" onclick=projectClick('"+ ent.id +"','" + ent.projectId + "','" + ent.deviceId + "')>选择</button></td>";
                                tr += " </tr>";
                            }
                            $("#trody").append(tr);
                            winIndex= layer.open({
                                      type: 1,
                                      title: '打开最近工作...',
                                      area: ['800px', '600px'],
                                      minHeight:'200px',
                                      content: $('#openShow') //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
                                      //,btn: ['按钮一', '按钮二', '按钮三']
                                      //,yes: function(index, layero){
                                      //  //按钮【按钮一】的回调
                                      //}
                                      //,btn2: function(index, layero){
                                      //  //按钮【按钮二】的回调

                                      //    return false; 开启该代码可禁止点击该按钮关闭
                                      //}
                                      //,btn3: function(index, layero){
                                      //  //按钮【按钮三】的回调

                                      //  //return false 开启该代码可禁止点击该按钮关闭
                                      //}
                                      //,cancel: function(){
                                      //  //右上角关闭回调

                                      //  //return false 开启该代码可禁止点击该按钮关闭
                                      //}
                                   });
                        }
                    }
                  });

            }
             //==============打开【最近项目，装置】end==================
             //==============隐藏下拉框==================
            function hidDropdownlist(currInt) {
                currInt = currInt + 1;
                for (var i = currInt; i < 10; i++) {//假设预留10个
                    if ($("select[name=sel" + i + "]").length > 0) {
                         $("select[name=sel" + i + "]").find("option:selected").text("");
                         $("#divsel"+i+"").hide();
                    }
                 }
             }
             //==============隐藏下拉框end==================

        });
         var winIndex = 0;
          //==============确定【项目】【装置】==================
            function selectProjectDevice() {
                var projectId = $("#selProject2").val();
                var deviceId = $("#selDevice2").val();
                $("#selProject").html($("#selProject2").html());
                $("#selDevice").html($("#selDevice2").html());

                $("#selProject").val(projectId);
                $("#selDevice").val(deviceId);
                layui.form.render('select');
                layer.close(winIndex);
             }
        //==============确定【项目】【装置】end==================
         //==============选择【项目】【装置】==================
        function projectClick(id,projectId, deviceId) {
            $("#selProject").val(projectId);
            $("#txtMtoId").val(id);
            layui.form.render('select');
            $.get("/CommodityCodeSelect/GetDropDownData?type=2&parentId=" + projectId + "&pt=" + Math.random(), function (result) {
                //<option value="-1">全部</option>
                if (result != null && result.length > 0) {
                    var optionHtml = "";
                    for (var i = 0; i < result.length; i++) {
                        optionHtml += "<option value="+result[i].value+">"+result[i].text+"</option>";
                    }
                    $("#selDevice").html(optionHtml);
                    $("#selDevice").val(deviceId);
                      layui.form.render('select');
                }
                  layer.close(winIndex);
            });
                layer.close(winIndex);
             }
        //==============选择【项目】【装置】end==================
          //==============打开【查看料表】==================
        function openReoprt() {
            var projectId = $("#selProject").val();
            var deviceId = $("#selDevice").val();
            var mtoId= $("#txtMtoId").val();
            if ((projectId == -1 || projectId == "" || projectId == null) || (deviceId == -1 || deviceId == "" || deviceId == null)) {
                layer.msg("【项目】和【装置】必须选择");
                return;
            }
            layer.open({
                            type: 2,
                            content: '/CommodityCodeSelect/ReportIndex?mtoId='+mtoId+'&projectId=' + projectId + "&deviceId=" + deviceId + "&" + Math.random(),
                            title: '选择采购码',
                            area: ["1000px;", "700px;"]//宽 高
                        });
         }
        //==============打开【查看料表】end==================
        //==============显示隐藏属性=========//

    function changeVisivility() {
        var isShow = $("#usteel-condition").is(":hidden");
        if (isShow) {
            $("#usteel-condition").show();
           $("#collaIcon").html(" &#xe61a; ");

        }
        else {
            $("#usteel-condition").hide();
            $("#collaIcon").html(" &#xe602; ");
        }
    }
        //============显示隐藏属性end==============//
</script>
